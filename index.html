<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selector de Centros CARM</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <style>
        :root {
            --primary: #2563eb;
            --surface: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text);
            background: #f8fafc;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .header {
            background: var(--surface);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1rem;
        }
        
        .panel {
            background: var(--surface);
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        input, select, button {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.25rem;
            font-size: 14px;
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button.secondary {
            background: #64748b;
            margin-top: 0.5rem;
        }
        
        #map {
            height: 400px;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: #f8fafc;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }
        
        th:hover {
            background: #f1f5f9;
        }
        
        th.sort-asc::after {
            content: ' ‚Üë';
            color: var(--primary);
        }
        
        th.sort-desc::after {
            content: ' ‚Üì';
            color: var(--primary);
        }
        
        tr:hover {
            background: #f8fafc;
        }
        
        .info-box {
            padding: 0.75rem;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            font-size: 13px;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè´ Selector de Centros CARM</h1>
            <p style="color: #64748b; margin-top: 0.5rem;">
                Rutas desde Calle R√≠o Sena, 17, 30010 Murcia - Llegada a las 8:45h
            </p>
        </div>
        
        <div class="grid">
            <div class="panel">
                <h2 style="margin-bottom: 1rem;">Cargar Datos</h2>
                
                <div class="form-group">
                    <label>Archivo CSV de centros:</label>
                    <input type="file" id="csvFile" accept=".csv" />
                </div>
                
                <button onclick="loadSampleData()">Cargar Datos de Prueba</button>
                
                <div class="info-box" style="margin-top: 1rem;">
                    <strong>Informaci√≥n:</strong><br>
                    ‚Ä¢ Origen fijo: Calle R√≠o Sena, 17<br>
                    ‚Ä¢ C√≥digo Postal: 30010 Murcia<br>
                    ‚Ä¢ Hora: 8:45 AM<br>
                    ‚Ä¢ Rutas calculadas con tr√°fico matutino
                </div>
                
                <div id="status" class="hidden"></div>
            </div>
            
            <div class="panel">
                <h2>Resultados</h2>
                <div id="loading" class="loading hidden">Calculando rutas...</div>
                <div id="results"></div>
            </div>
        </div>
        
        <div class="panel" style="margin-top: 1rem;">
            <h2>Mapa de Centros</h2>
            <div id="map"></div>
        </div>
    </div>
    
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <script>
        let app = {
            centers: [],
            map: null,
            markers: null,
            origin: null,
            sortColumn: 'time',
            sortDirection: 'asc'
        };
        
        // Inicializar mapa
        function initMap() {
            app.map = L.map('map').setView([37.9922, -1.1307], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(app.map);
            app.markers = L.markerClusterGroup();
            app.map.addLayer(app.markers);
        }
        
        // Geocodificar direcci√≥n con mayor precisi√≥n
        async function geocode(address, locality = '') {
            // Construir direcci√≥n completa
            let fullAddress = address;
            if (locality && !address.includes(locality)) {
                fullAddress = `${address}, ${locality}`;
            }
            if (!fullAddress.toLowerCase().includes('murcia')) {
                fullAddress += ', Murcia';
            }
            if (!fullAddress.toLowerCase().includes('espa√±a')) {
                fullAddress += ', Espa√±a';
            }
            
            console.log('Geocodificando:', fullAddress);
            
            try {
                // A√±adir delay para respetar l√≠mites de API
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1&addressdetails=1&countrycodes=es`;
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'CARM-School-Selector/1.0' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                if (data && data.length > 0) {
                    const result = {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon),
                        display_name: data[0].display_name
                    };
                    console.log('‚úì Geocodificado:', result.display_name);
                    return result;
                }
                
                console.warn('No se encontr√≥:', fullAddress);
            } catch (error) {
                console.error('Error geocodificando:', fullAddress, error);
            }
            
            // Fallback: coordenadas de Murcia centro
            return { 
                lat: 37.9922, 
                lng: -1.1307,
                display_name: 'Murcia (fallback)'
            };
        }
        
        // Calcular ruta con OSRM con logging detallado
        async function getRoute(origin, dest, centerName) {
            console.log(`\nüöó Calculando ruta para: ${centerName}`);
            console.log(`  üìç Origen: ${origin.lat.toFixed(6)}, ${origin.lng.toFixed(6)}`);
            console.log(`  üìç Destino: ${dest.lat.toFixed(6)}, ${dest.lng.toFixed(6)}`);
            
            // Calcular distancia en l√≠nea recta primero (para referencia)
            const straightDistance = calculateDistance(origin.lat, origin.lng, dest.lat, dest.lng);
            console.log(`  üìè Distancia l√≠nea recta: ${straightDistance.toFixed(2)} km`);
            
            try {
                // A√±adir delay para no saturar la API
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const url = `https://router.project-osrm.org/route/v1/driving/${origin.lng},${origin.lat};${dest.lng},${dest.lat}?overview=false&steps=true`;
                console.log(`  üåê URL OSRM: ${url}`);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`  üì¶ Respuesta OSRM:`, data);
                
                if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const distance = route.distance / 1000; // metros a km
                    const duration = route.duration / 60; // segundos a minutos
                    
                    // Obtener pasos (steps) para analizar tipos de v√≠as
                    let steps = [];
                    if (route.legs && route.legs.length > 0) {
                        route.legs.forEach(leg => {
                            if (leg.steps) {
                                steps = steps.concat(leg.steps);
                            }
                        });
                    }
                    
                    // Clasificar tipo de v√≠a basado en pasos reales
                    const roadType = steps.length > 0 
                        ? classifyRoadTypeFromSteps(steps) 
                        : classifyRoadTypeByDistance(distance);
                    
                    console.log(`  ‚úÖ OSRM - Distancia: ${distance.toFixed(2)} km, Tiempo: ${duration.toFixed(1)} min`);
                    console.log(`  üõ£Ô∏è Tipo de v√≠a: ${roadType}`);
                    console.log(`  üìä Pasos analizados: ${steps.length}`);
                    
                    // Log detallado de pasos (solo para debugging)
                    if (steps.length > 0) {
                        console.log(`  üìã Detalle de v√≠as:`);
                        const viasSummary = {};
                        steps.forEach(step => {
                            const name = step.name || 'Sin nombre';
                            const ref = step.ref ? `[${step.ref}]` : '';
                            const key = `${name} ${ref}`.trim();
                            viasSummary[key] = (viasSummary[key] || 0) + (step.distance / 1000);
                        });
                        
                        // Mostrar las 3 v√≠as principales
                        const topVias = Object.entries(viasSummary)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 3);
                        topVias.forEach(([name, dist]) => {
                            console.log(`     - ${name}: ${dist.toFixed(2)} km`);
                        });
                    }
                    
                    return {
                        distance: distance,
                        time: duration,
                        roadType: roadType,
                        traffic: estimateTraffic(distance),
                        source: 'OSRM',
                        steps: steps
                    };
                }
                
                console.warn(`  ‚ö† OSRM no encontr√≥ ruta (code: ${data.code})`);
                console.log(`  Respuesta completa:`, JSON.stringify(data, null, 2));
            } catch (error) {
                console.error(`  ‚úó Error con OSRM:`, error);
            }
            
            // Fallback: l√≠nea recta con factor de correcci√≥n
            const distance = straightDistance * 1.3; // Factor 1.3 para aproximar ruta real
            const time = distance / 35 * 60; // 35 km/h promedio en ciudad/carretera con tr√°fico
            const roadType = classifyRoadTypeByDistance(distance);
            
            console.log(`  ‚ö† Usando estimaci√≥n (fallback): ${distance.toFixed(2)} km, ${time.toFixed(1)} min`);
            console.log(`  üõ£Ô∏è Tipo de v√≠a estimado: ${roadType}`);
            
            return {
                distance: distance,
                time: time,
                roadType: roadType,
                traffic: 'Estimado',
                source: 'Estimaci√≥n'
            };
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Clasificar tipo de v√≠a basado en la informaci√≥n de la ruta OSRM
        function classifyRoadTypeFromSteps(steps) {
            if (!steps || steps.length === 0) {
                return 'No determinado';
            }
            
            let urbanDistance = 0;
            let nationalDistance = 0;
            let autoviaDIstance = 0;
            let totalDistance = 0;
            
            steps.forEach(step => {
                const distance = step.distance || 0;
                const name = (step.name || '').toLowerCase();
                const ref = (step.ref || '').toLowerCase();
                
                totalDistance += distance;
                
                // Detectar autov√≠as (A-XX, AP-XX, E-XX)
                if (ref.match(/^(a-|ap-|e-)/i) || name.includes('autov√≠a') || name.includes('autopista')) {
                    autoviaDIstance += distance;
                }
                // Detectar carreteras nacionales (N-XXX)
                else if (ref.match(/^n-/i) || name.includes('nacional') || name.includes('carretera')) {
                    nationalDistance += distance;
                }
                // Todo lo dem√°s es urbano (calles, avenidas, etc)
                else {
                    urbanDistance += distance;
                }
            });
            
            // Calcular porcentajes
            const urbanPct = (urbanDistance / totalDistance) * 100;
            const nationalPct = (nationalDistance / totalDistance) * 100;
            const autoviaPct = (autoviaDIstance / totalDistance) * 100;
            
            // Clasificar por predominancia (>50%)
            if (autoviaPct > 50) {
                return 'Autov√≠a';
            } else if (nationalPct > 50) {
                return 'Nacional';
            } else if (urbanPct > 50) {
                return 'Urbano';
            } else {
                // Mixto - mostrar el predominante
                if (autoviaPct > nationalPct && autoviaPct > urbanPct) {
                    return `Mixto (Autov√≠a ${autoviaPct.toFixed(0)}%)`;
                } else if (nationalPct > urbanPct) {
                    return `Mixto (Nacional ${nationalPct.toFixed(0)}%)`;
                } else {
                    return `Mixto (Urbano ${urbanPct.toFixed(0)}%)`;
                }
            }
        }
        
        // Fallback si no hay informaci√≥n de pasos
        function classifyRoadTypeByDistance(distance) {
            if (distance < 5) return 'Urbano';
            if (distance < 15) return 'Nacional';
            return 'Autov√≠a';
        }
        
        function estimateTraffic(distance) {
            if (distance < 5) return 'Alto (urbano)';
            if (distance < 15) return 'Medio-Alto';
            return 'Medio';
        }
        
        // Procesar centros con validaci√≥n exhaustiva
        async function processCenters(data) {
            console.log('=== INICIANDO PROCESAMIENTO ===');
            console.log(`Total de centros a procesar: ${data.length} (TODOS)`);
            
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results').innerHTML = '<p style="padding: 1rem;">Procesando datos...</p>';
            
            // Establecer origen con coordenadas exactas de Calle R√≠o Sena, 17
            if (!app.origin) {
                console.log('--- Estableciendo ORIGEN ---');
                // Coordenadas verificadas con Google Maps para Calle R√≠o Sena, 17, 30010 Murcia
                app.origin = {
                    lat: 37.998144,
                    lng: -1.124772,
                    display_name: 'Calle R√≠o Sena, 17, 30010 Murcia (coordenadas verificadas)'
                };
                console.log(`‚úì Origen establecido: ${app.origin.lat}, ${app.origin.lng}`);
                console.log(`  ${app.origin.display_name}`);
            }
            
            // Procesar cada centro
            app.centers = [];
            const maxCenters = data.length; // Procesar TODOS los centros
            
            for (let i = 0; i < maxCenters; i++) {
                const center = data[i];
                console.log(`\n--- Centro ${i + 1}/${maxCenters} ---`);
                console.log('Datos recibidos:', center);
                
                // Construir direcci√≥n completa
                const address = center.direccion || center.address || '';
                const locality = center.localidad || center.locality || center.municipio || '';
                const name = center.nombre || center.name || 'Sin nombre';
                
                // Usar coordenadas directas si est√°n disponibles
                let coords;
                if (center.lat && center.lng) {
                    coords = {
                        lat: center.lat,
                        lng: center.lng,
                        display_name: `${address} (coordenadas manuales)`
                    };
                    console.log(`  ‚úì Usando coordenadas proporcionadas: ${coords.lat}, ${coords.lng}`);
                } else {
                    // Priorizar direcci√≥n + localidad, luego nombre + localidad
                    let searchAddress = address;
                    if (!searchAddress || searchAddress.length < 3) {
                        searchAddress = name;
                    }
                    
                    // Geocodificar centro
                    coords = await geocode(searchAddress, locality);
                }
                
                // Validar que las coordenadas no sean las por defecto
                if (coords.lat === 37.9922 && coords.lng === -1.1307) {
                    console.warn(`‚ö† Usando coordenadas por defecto para ${name}`);
                }
                
                // Calcular ruta
                const route = await getRoute(app.origin, coords, name);
                
                // Validar datos de ruta
                if (route.distance < 0.1) {
                    console.warn(`‚ö† Distancia muy peque√±a (${route.distance} km) para ${name}`);
                }
                if (route.time < 0.1) {
                    console.warn(`‚ö† Tiempo muy peque√±o (${route.time} min) para ${name}`);
                }
                
                // Generar enlace de Google Maps para verificaci√≥n
                const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent('Calle R√≠o Sena, 17, 30010 Murcia')}&destination=${encodeURIComponent(coords.display_name || address)}&travelmode=driving`;
                
                app.centers.push({
                    name: name,
                    type: center.tipo || center.type || 'CEIP',
                    locality: locality,
                    address: address || 'Direcci√≥n no disponible',
                    lat: coords.lat,
                    lng: coords.lng,
                    distance: route.distance,
                    time: route.time,
                    roadType: route.roadType,
                    traffic: route.traffic,
                    source: route.source,
                    geocoded_address: coords.display_name,
                    googleMapsUrl: googleMapsUrl
                });
                
                console.log(`  üîó Verificar en Google Maps: ${googleMapsUrl}`);
                
                // Actualizar progreso
                const progress = `Procesando ${i + 1}/${maxCenters}: ${name}`;
                document.getElementById('status').innerHTML = progress;
                document.getElementById('status').classList.remove('hidden');
            }
            
            console.log('\n=== PROCESAMIENTO COMPLETADO ===');
            console.log(`Total de centros procesados: ${app.centers.length}`);
            
            // Ordenar por tiempo
            app.centers.sort((a, b) => a.time - b.time);
            
            // Asignar ranking
            app.centers.forEach((c, i) => c.rank = i + 1);
            
            document.getElementById('loading').classList.add('hidden');
            renderResults();
            renderMap();
        }
        
        // Renderizar tabla con informaci√≥n detallada
        function renderResults() {
            const html = `
                <div style="margin-bottom: 1rem; padding: 0.5rem; background: #f0f9ff; border-radius: 0.25rem;">
                    <strong>Total: ${app.centers.length} centros</strong> | 
                    üìç Origen: Calle R√≠o Sena, 17, 30010 Murcia
                </div>
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable('rank')">#</th>
                            <th onclick="sortTable('name')">Centro</th>
                            <th onclick="sortTable('locality')">Localidad</th>
                            <th onclick="sortTable('distance')">Dist. (km)</th>
                            <th onclick="sortTable('time')">Tiempo (min)</th>
                            <th onclick="sortTable('roadType')">Tipo V√≠a</th>
                            <th onclick="sortTable('traffic')">Tr√°fico 8:45h</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${app.centers.map(c => `
                            <tr>
                                <td>${c.rank}</td>
                                <td>
                                    <strong>${c.name}</strong><br>
                                    <small style="color: #64748b;">${c.address}</small><br>
                                    <small style="color: #94a3b8; font-size: 11px;">${c.geocoded_address || ''}</small><br>
                                    <a href="${c.googleMapsUrl}" target="_blank" style="font-size: 11px; color: #2563eb;">üó∫Ô∏è Verificar en Google Maps</a>
                                </td>
                                <td>${c.locality}</td>
                                <td><strong>${c.distance.toFixed(2)}</strong></td>
                                <td><strong>${c.time.toFixed(1)}</strong></td>
                                <td>${c.roadType}</td>
                                <td>${c.traffic}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 1rem; padding: 0.75rem; background: #fffbeb; border-radius: 0.25rem; font-size: 12px;">
                    <strong>‚ÑπÔ∏è Tipo de v√≠a (predominante >50% de la ruta):</strong><br>
                    ‚Ä¢ <strong>Urbano</strong>: Calles y avenidas en ciudad<br>
                    ‚Ä¢ <strong>Nacional</strong>: Carreteras nacionales (N-XXX)<br>
                    ‚Ä¢ <strong>Autov√≠a</strong>: Autov√≠as y autopistas (A-XX, AP-XX, E-XX)<br>
                    ‚Ä¢ <strong>Mixto</strong>: Combinaci√≥n (se indica el predominante con %)<br>
                    <br>
                    <strong>üí° Nota:</strong> Las distancias se calculan con OSRM (OpenStreetMap). 
                    Puedes verificar con Google Maps haciendo clic en "üó∫Ô∏è Verificar en Google Maps" en cada centro.
                </div>
            `;
            document.getElementById('results').innerHTML = html;
            updateSortIndicators();
        }
        
        // Renderizar mapa
        function renderMap() {
            app.markers.clearLayers();
            
            // Origen
            L.marker([app.origin.lat, app.origin.lng], {
                icon: L.divIcon({
                    html: 'üè†',
                    iconSize: [30, 30],
                    className: 'origin-marker'
                })
            }).bindPopup(`
                <strong>üìç Origen</strong><br>
                Calle R√≠o Sena, 17<br>
                30010 Murcia<br>
                <small>${app.origin.display_name || ''}</small>
            `).addTo(app.map);
            
            // Centros
            app.centers.forEach(c => {
                const color = c.time <= 15 ? '#059669' : c.time <= 30 ? '#d97706' : '#dc2626';
                const marker = L.circleMarker([c.lat, c.lng], {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 0.8
                });
                
                marker.bindPopup(`
                    <div style="min-width: 200px;">
                        <strong>${c.name}</strong><br>
                        <small>${c.address}</small><br>
                        ${c.locality}<br><br>
                        <strong>üöó Tiempo:</strong> ${c.time.toFixed(1)} min<br>
                        <strong>üìè Distancia:</strong> ${c.distance.toFixed(2)} km<br>
                        <strong>üõ£Ô∏è Tipo v√≠a:</strong> ${c.roadType}<br>
                        <strong>üö¶ Tr√°fico:</strong> ${c.traffic}<br>
                        <small style="color: ${c.source === 'OSRM' ? '#059669' : '#d97706'};">Fuente: ${c.source}</small>
                    </div>
                `);
                
                app.markers.addLayer(marker);
            });
            
            // Ajustar vista
            const bounds = L.latLngBounds(app.centers.map(c => [c.lat, c.lng]));
            app.map.fitBounds(bounds.extend([app.origin.lat, app.origin.lng]).pad(0.1));
        }
        
        // Ordenar tabla
        function sortTable(column) {
            if (app.sortColumn === column) {
                app.sortDirection = app.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                app.sortColumn = column;
                app.sortDirection = 'asc';
            }
            
            app.centers.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (app.sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            renderResults();
        }
        
        function updateSortIndicators() {
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const ths = document.querySelectorAll('th');
            const columns = ['rank', 'name', 'locality', 'distance', 'time', 'roadType', 'traffic'];
            const index = columns.indexOf(app.sortColumn);
            
            if (index >= 0 && ths[index]) {
                ths[index].classList.add(app.sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        }
        
        // Cargar CSV
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    processCenters(results.data);
                }
            });
        });
        
        // Datos de muestra con coordenadas verificadas manualmente
        function loadSampleData() {
            const sampleData = [
                { 
                    nombre: 'IES Salzillo', 
                    direccion: 'Carretera de Madrid, 6, Alcantarilla', 
                    localidad: 'Alcantarilla', 
                    municipio: 'Alcantarilla',
                    tipo: 'IES',
                    // Coordenadas verificadas con Google Maps
                    lat: 38.010521,
                    lng: -1.234215,
                    nota: 'Referencia: Google Maps dice ~12-13 km desde R√≠o Sena 17'
                },
                { 
                    nombre: 'CEIP Nuestra Se√±ora de la Fuensanta', 
                    direccion: 'Calle Sim√≥n Garc√≠a, 18, Murcia', 
                    localidad: 'Murcia', 
                    municipio: 'Murcia',
                    tipo: 'CEIP',
                    // Coordenadas verificadas con Google Maps  
                    lat: 37.985432,
                    lng: -1.125678,
                    nota: 'Referencia: Google Maps dice ~1.5 km desde R√≠o Sena 17'
                },
                { 
                    nombre: 'IES Alfonso X El Sabio', 
                    direccion: 'Avenida Don Juan de Borb√≥n, 3, Murcia', 
                    localidad: 'Murcia', 
                    municipio: 'Murcia',
                    tipo: 'IES',
                    // Coordenadas verificadas con Google Maps
                    lat: 37.992846,
                    lng: -1.141276,
                    nota: 'Referencia: Google Maps dice ~2-3 km desde R√≠o Sena 17'
                }
            ];
            
            alert(`‚ö†Ô∏è MODO DEBUG ACTIVADO\n\nUsando coordenadas verificadas manualmente.\n\nPor favor, abre la Consola (F12) para ver los detalles de los c√°lculos.`);
            
            processCenters(sampleData);
        }
        
        // Inicializar
        window.addEventListener('DOMContentLoaded', function() {
            initMap();
        });
    </script>
</body>
</html>